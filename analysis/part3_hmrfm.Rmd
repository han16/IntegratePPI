---
title: "HMRFM"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
date: "2024-10-02"
---



## selecting incidence matrix 


```{r, message=F, warning=F, eval=T}
# curate the adj_pfc35 by incorporating PPI information 
load("C:\\han\\Projects\\Multi_Omics\\data_in_MOBS\\adj_pfc35.RData")  # load incidence matrix 
load("C:\\han\\Projects\\IntegratePPI\\string.keep_gene_level.RData")  # load pairwise protein interaction information  

### build incidence matrix, (i,j)=1 if there is a link between genes, i & j, and 0 otherwise
#string_incidence=matrix(0, nrow=nrow(adj_pfc35), ncol=nrow(adj_pfc35))
#for (i in 1:(nrow(adj_pfc35)-1))
#  for (j in (i+1):nrow(adj_pfc35))
#    if (string.keep_gene_level_new %>% filter(protein1_gene==colnames(dat_pfc35)[i], protein2_gene==colnames(dat_pfc35)[j]) %>% nrow()>0)
#      { 
#      cat(i, "th gene is running", "\n")
#      string_incidence[i,j]=1
#      string_incidence[j,i]=1
#     }
  
#save(string_incidence, file ="C:\\han\\Projects\\IntegratePPI\\string_incidence.RData")  
load("C:\\han\\Projects\\IntegratePPI\\string_incidence.RData")
        
###### combine estimated incidence matrix and string PPI information, a link between two genes exists if it appears in estimated incidence matrix or string PPI  
adj_string_combine_incidence=adj_pfc35+string_incidence
for (i in 1:(nrow(adj_string_combine_incidence)-1))
  for (j in (i+1):ncol(adj_string_combine_incidence))
    if (adj_string_combine_incidence[i,j]>1)
    {
      adj_string_combine_incidence[i,j]=1
      adj_string_combine_incidence[j,i]=1
    }


net=network(as.matrix(adj_string_combine_incidence), directed=FALSE) # https://web.stanford.edu/class/bios221/labs/networks/lab_7_networks.html
set.seed(1)          # make the plot look the same as mine
par(mar=rep(0,4))

plot(net, vertex.cex=0.15, rescale=F) # vextex.cex control the vertex size

#dev.off()


```



## run HMRF to get risk genes 


```{r, message=F, warning=F, eval=T}
# run the HMRF
fdr_cutoff <- 0.01
source("C:\\han\\Projects\\Multi_Omics\\data_in_MOBS\\hmrf.r")
source("C:\\han\\Projects\\Multi_Omics\\data_in_MOBS\\misc.r")
load("C:\\han\\Projects\\Multi_Omics\\data_in_MOBS\\adj_pfc35.RData")
seedindex <- rep(0, ncol(adj_pfc35))
seedindex[which(tada$dn.LoF >= 3)] <- 1

#hmrf_pfc35 <- covarianceSelection::hmrf(tada$pval.TADA, adj_pfc35, seedindex, pthres = pthres)
#hmrf_pfc35 <- hmrf(tada$pval.TADA, adj_pfc35, seedindex, pthres = pthres)
hmrf_pfc35_string <- hmrf(tada$pval.TADA, string_incidence, seedindex, pthres = pthres)
#report_pfc35 <- covarianceSelection::report_results(tada$Gene, 1-hmrf_pfc35$post, tada$pval.TADA, hmrf_pfc35$Iupdate)
report_pfc35_string <- report_results(tada$Gene, 1-hmrf_pfc35_string$post, tada$pval.TADA, hmrf_pfc35_string$Iupdate)
genes_pfc35_string <- sort(as.character(report_pfc35_string$Gene[which(report_pfc35_string$FDR <= fdr_cutoff)]))

genes_pfc35_string

########################

# plot(exp(seq(log(0.01), log(0.35), length.out = length(scale_vec_pfc35))), scale_vec_pfc35)
```
